# `docs/domain-model.md`

## The Janus Project: Domain Model Specification

This document specifies the core data model for the Janus Project. The model is designed with the principles of functional programming and type-driven development in mind. It prioritizes immutability, explicit versioning, and a clear audit trail for all entities.

### Core Principles

- **Branded Types for IDs:** To ensure type safety at the application level, all entity IDs are represented by "branded" or "opaque" types. This prevents accidentally using a `SnippetId` where a `CompositionId` is expected.
- **Application-Managed UUIDs:** All entity IDs are string UUIDs generated by the application. This supports decentralized creation of entities without ID conflicts, which is essential for a collaborative tool.
- **The `Slug` Type:** All human-readable names that are used for lookups (e.g., snippet names, parameter names) are constrained to a `Slug` type. This type is a URL- and command-line-friendly string (e.g., `lowercase-with-hyphens`) and can only be created via a smart constructor that performs validation.

---

### Entity Definitions

#### 1. Snippets

Snippets are the fundamental, reusable building blocks of prompts.

**`Snippet`**
The abstract container for a snippet and all its versions. It holds the consistent name.

```typescript
type SnippetId = string & { readonly __brand: 'SnippetId' };
type Slug = string & { readonly __brand: 'Slug' };

type Snippet = {
  id: SnippetId;
  name: Slug;
  description: string;
};
```

**`SnippetVersion`**
An immutable snapshot of a snippet's content at a specific point in time.

```typescript
type SnippetVersionId = string & { readonly __brand: 'SnippetVersionId' };

type SnippetVersion = {
  id: SnippetVersionId;
  content: string; // A template string, e.g., "You {{obligation_level}} to..."
  createdAt: Date;
  commit_message: string; // A mandatory message explaining the change.
};
```

#### 2. Parameters

Parameters are the named variables that can be injected into `SnippetVersion` content.

**`Parameter`**
The abstract definition of a parameter.

```typescript
type ParameterId = string & { readonly __brand: 'ParameterId' };

type Parameter = {
  id: ParameterId;
  name: Slug;
  description: string;
};
```

**`ParameterOption`**
A specific, versioned value for a `Parameter`.

```typescript
type ParameterOptionId = string & { readonly __brand: 'ParameterOptionId' };

type ParameterOption = {
  id: ParameterOptionId;
  value: string; // The actual value, e.g., "have to"
  createdAt: Date;
  commit_message: string;
};
```

#### 3. Compositions

Compositions are recipes that define how to assemble multiple `SnippetVersion`s into a complete, runnable prompt.

**`Composition`**
The abstract container for a composition and all its versions.

```typescript
type CompositionId = string & { readonly __brand: 'CompositionId' };

type Composition = {
  id: CompositionId;
  name: Slug;
  description: string;
};
```

**`CompositionVersion`**
An immutable snapshot of a composition, locking in specific `SnippetVersion`s in a defined order and role.

```typescript
type CompositionVersionId = string & {
  readonly __brand: 'CompositionVersionId';
};

type CompositionSnippet = {
  snippetVersionId: SnippetVersionId;
  role: 'system' | 'user_prompt' | 'model_response';
  sequence: number; // The order of the snippet within its role.
};

type CompositionVersion = {
  id: CompositionVersionId;
  snippets: CompositionSnippet[];
  createdAt: Date;
  commit_message: string;
};
```

#### 4. Testing & Results

These entities store the configuration and output of an experiment.

**`TestRun`**
The parent container for a single execution of a test suite.

```typescript
type TestRunId = string & { readonly __brand: 'TestRunId' };

type TestRun = {
  id: TestRunId;
  name: string;
  createdAt: Date;
  llm_provider: string;
  llm_model: string;
  metadata: Record<string, any>; // A flexible JSON blob for user metadata.
};
```

**`DataPoint`**
The result of a single LLM call within a `TestRun`.

```typescript
type DataPointId = string & { readonly __brand: 'DataPointId' };

type DataPoint = {
  id: DataPointId;
  final_prompt_text: string;
  response_text: string;
  metrics: Record<string, any>; // JSON blob for latency, token counts, etc.
};
```

#### 5. Categorization

**`Tag`**
A simple label for organizing and querying entities.

```typescript
type TagId = string & { readonly __brand: 'TagId' };

type Tag = {
  id: TagId;
  name: Slug;
};
```

---

### Relationship Definitions

These relationships define the connections between entities in the Neo4j graph.

- `(SnippetVersion) -[:VERSION_OF]-> (Snippet)`
  - Links a specific version to its abstract parent.
- `(SnippetVersion) -[:PREVIOUS_VERSION]-> (SnippetVersion)`
  - Creates a chronological linked-list of a snippet's history.
- `(SnippetVersion) -[:DEFINES_PARAMETER]-> (Parameter)`
  - Specifies that a snippet's content uses a given parameter.
- `(Parameter) -[:HAS_OPTION]-> (ParameterOption)`
  - Links a parameter definition to one of its possible values.
- `(CompositionVersion) -[:VERSION_OF]-> (Composition)`
  - Links a specific composition version to its abstract parent.
- `(CompositionVersion) -[:PREVIOUS_VERSION]-> (CompositionVersion)`
  - Creates a chronological linked-list of a composition's history.
- `(CompositionVersion) -[:DERIVED_FROM]-> (CompositionVersion)`
  - Tracks the lineage of how compositions were evolved from one another.
- `(CompositionVersion) -[:INCLUDES { role: string, sequence: number }]-> (SnippetVersion)`
  - The core composition relationship. Properties on the edge define the snippet's role and order.
- `(TestRun) -[:GENERATED]-> (DataPoint)`
  - Links a test run to the individual data points it produced.
- `(DataPoint) -[:USING_COMPOSITION]-> (CompositionVersion)`
  - Links a result back to the exact, immutable composition that created it.
- `(Snippet) -[:HAS_TAG]-> (Tag)`
  - Applies a categorical tag to a snippet.
- `(Composition) -[:HAS_TAG]-> (Tag)`
  - Applies a categorical tag to a composition.

---

### Visual Diagram (Mermaid)

```mermaid
graph TD
    subgraph "Prompt Building Blocks"
        T(Tag)
        S(Snippet) -- name, desc --> SV(SnippetVersion) -- content, commit_message
        P(Parameter) -- name, desc --> PO(ParameterOption) -- value, commit_message

        S -- HAS_TAG --> T
        SV -- VERSION_OF --> S
        SV -- PREVIOUS_VERSION --> SV
        SV -- DEFINES_PARAMETER --> P
    end

    subgraph "Prompt Assembly"
        C(Composition) -- name, desc --> CV(CompositionVersion) -- commit_message
        C -- HAS_TAG --> T
        CV -- VERSION_OF --> C
        CV -- PREVIOUS_VERSION --> CV
        CV -- DERIVED_FROM --> CV
        CV -- "INCLUDES <br> {role, sequence}" --> SV
    end

    subgraph "Experimentation & Results"
        TR(TestRun) -- llm_model, metadata --> DP(DataPoint) -- response, metrics
        TR -- GENERATED --> DP
        DP -- USING_COMPOSITION --> CV
    end
```
